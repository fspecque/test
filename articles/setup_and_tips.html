<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Generic advice about setting up and using conda environments • SeuratIntegrate</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Generic advice about setting up and using conda environments">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SeuratIntegrate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/SeuratIntegrate.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/introduction.html">Integration example: pbmcsca data</a></li>
    <li><a class="dropdown-item" href="../articles/setup_and_tips.html">Advice about conda and future</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Aide-mémoires"><span class="fa fa-sticky-note"></span></button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-">
<li><a class="dropdown-item" href="../articles/memo_integration.html">Integration methods</a></li>
    <li><a class="dropdown-item" href="../articles/memo_score.html">Scoring metrics</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cbib/Seurat-Integrate/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Generic advice about setting up and using conda environments</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cbib/Seurat-Integrate/blob/main/vignettes/setup_and_tips.Rmd" class="external-link"><code>vignettes/setup_and_tips.Rmd</code></a></small>
      <div class="d-none name"><code>setup_and_tips.Rmd</code></div>
    </div>

    
    
<style type="text/css">
.darker-code {
  color: #2f2f2f;
}
.red-warn {
  color: red;
}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>SeuratIntegrate</code>’s main purpose is to extend the range of
scRNA-seq integration tools available in R and compatible with
<code>Seurat</code>. Many of them being solely available in Python, we
developed wrappers leveraging <code>reticulate</code> package’s
capabilities. <code>reticulate</code> enables to directly call Python
from R, give that conda environments have been set up beforehand.</p>
<p>The purpose of this vignette is to illustrate and ease the
installation and the use of those environments.</p>
<p>Prior to starting, make sure you have:</p>
<ul>
<li>conda <strong>installed</strong> on your machine</li>
<li>conda binary in your <strong><code>PATH</code></strong> (or that you
know its location)</li>
</ul>
</div>
<div class="section level2">
<h2 id="set-up">Set-up<a class="anchor" aria-label="anchor" href="#set-up"></a>
</h2>
<p>We need multiple conda environments. One for <code>bbknn</code>, one
for <code>Scanorama</code>, one for
<code>scVI</code>/<code>scANVI</code> and one for <code>trVAE</code>. If
you don’t plan on using any or some of these methods, whether you decide
to set up their respective conda environments is up to you.</p>
<p>One the contrary, if you already have some conda environments with
appropriate libraries on your machine, you can tell
<code>SeuratIntegrate</code> to use them. Let’s see how.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cbib/Seurat-Integrate" class="external-link">SeuratIntegrate</a></span><span class="op">)</span></span></code></pre></div>
<p>Have look at your <code>CondaEnvManager</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getCache.html">getCache</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="img%2Fconda_envs_unset.png" alt="Unset conda environments" width="100%" style="display: block; margin: auto;"></p>
<p>It’s a handy way to have a glance at all the implemented methods and
the status of their conda environments. <code>ComBat</code>,
<code>Harmony</code> and <code>MNN</code> are R-based methods and don’t
need any conda environment. The rest of them however are Python-based
and will function through <code>reticulate</code>, hence require conda
environments.</p>
<p>If you don’t have any conda environments for them, look at the <a href="#create_env">next sub-section</a>. Conversely, if you want to add
an existing conda environment, directly go to the <a href="#use_env">following one</a>.</p>
<div class="section level3">
<h3 id="create_env">Option 1: Create new conda environments with
<code>SeuratIntegrate</code><a class="anchor" aria-label="anchor" href="#create_env"></a>
</h3>
<p><strong>Note that the commands below have only been tested on Linux
distributions</strong></p>
<p>Try the following commands (be aware that execution might take
time):</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span><span class="st">'bbknn'</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span><span class="st">'scvi'</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span><span class="st">'scanorama'</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span><span class="st">'trvae'</span><span class="op">)</span></span></code></pre></div>
<p>Note that:</p>
<ul>
<li>if conda is not in you PATH set
<code>conda.bin = /path/to/conda</code>
</li>
<li>
<code>scVI</code> and <code>scANVI</code> share the same
environment. Hence, it is not necessary to run both
<code>UpdateEnvCache('scvi')</code> and
<code>UpdateEnvCache('scanvi')</code>
</li>
</ul>
<p>Have look at your <code>CondaEnvManager</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getCache.html">getCache</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="img%2Fconda_envs_set.png" alt="Fully set conda environments" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="use_env">Option 2: Use existing conda environments<a class="anchor" aria-label="anchor" href="#use_env"></a>
</h3>
<p>If you already have one (several) existing conda environment(s) for
one (some) of the methods, you can tell <code>SeuratIntegrate</code> to
use it (them). Similarly, if you run into problems with
<code><a href="../reference/UpdateEnvCache.html">UpdateEnvCache()</a></code> commands above, the alternative is to set
up conda environments yourself and provide them to
<code>SeuratIntegrate</code>. Whatever the case, let’s proceed.</p>
<p>You’ll use <code><a href="../reference/UpdateEnvCache.html">UpdateEnvCache()</a></code>. You can specify the name of
the conda environment or the path to it. By default,
<code><a href="../reference/UpdateEnvCache.html">UpdateEnvCache()</a></code> will try to decide whether the provided
value for <code>conda.env</code> is a path or a name based on simple
tests. To avoid any misinterpretation, you can use
<code>conda.env.is.path = TRUE</code> or <code>FALSE</code> when your
input is the path or the name of the environment, respectively.
<strong>But beware not to make mistakes !!!</strong></p>
<p>See examples below. You should adapt the arguments to your
situation:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># environment for bbknn</span></span>
<span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span><span class="st">'bbknn'</span>, conda.env <span class="op">=</span> <span class="st">'bbknn_env'</span>,</span>
<span>               conda.env.is.path <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>   <span class="co"># default 'auto' would work</span></span>
<span></span>
<span><span class="co"># environment for bbknn in ./bbknn_env/</span></span>
<span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span><span class="st">'bbknn'</span>, conda.env <span class="op">=</span> <span class="st">'bbknn_env'</span>,</span>
<span>               conda.env.is.path <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># environment for bbknn, conda binary not in PATH</span></span>
<span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span><span class="st">'bbknn'</span>, conda.env <span class="op">=</span> <span class="st">'bbknn_env'</span>, conda.bin <span class="op">=</span> <span class="st">'cutom/location/conda'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># path for scvi-tools</span></span>
<span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span><span class="st">'scvi'</span>, conda.env <span class="op">=</span> <span class="st">'~/miniconda3/envs/scvi-tools_env'</span>,</span>
<span>               conda.env.is.path <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>   <span class="co"># default 'auto' would work</span></span></code></pre></div>
<p>Note that:</p>
<ul>
<li>if conda is not in you PATH set
<code>conda.bin = /path/to/conda</code>
</li>
<li>the <code>conda.bin</code> must correspond to the conda managing the
<code>conda.env</code>
</li>
<li>
<code>scVI</code> and <code>scANVI</code> share the same
environment. Hence, it is not necessary to run both
<code>UpdateEnvCache('scvi')</code> and
<code>UpdateEnvCache('scanvi')</code>
</li>
</ul>
<p>Now you can use the Python-based methods !</p>
</div>
<div class="section level3">
<h3 id="update-or-reset-conda-environments">Update or reset conda environments<a class="anchor" aria-label="anchor" href="#update-or-reset-conda-environments"></a>
</h3>
<p>If you want to update a <code>conda</code> environment, use</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># change 'method' by the name of the method</span></span>
<span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'method'</span>, overwrite.env <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>To unset an environment, use</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># change 'method' by the name of the method</span></span>
<span><span class="fu"><a href="../reference/resetCache.html">resetCache</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'method'</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="troubleshouting-with-conda">Troubleshouting with conda<a class="anchor" aria-label="anchor" href="#troubleshouting-with-conda"></a>
</h2>
<div class="section level3">
<h3 id="install_problem">Common issues with setting up environments<a class="anchor" aria-label="anchor" href="#install_problem"></a>
</h3>
<p>It can happen that a conda environment cannot be installed on a
specific machine or os. In this case, there is hardly anything better to
do than browse the internet in hope that someone else has experienced a
similar problem and that the solution is public. Otherwise, try to
modify the set of packages to install, be more or less stringent with
package versions to install, etc. You can also create a conda
environment with Python and pip, and then to try to install packages
with pip rather than conda.</p>
<p>Once the problem is solved (if it can be), you can save the new
environment to the <code>CondaEnvManager</code> with</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># change 'method' by the name of the method</span></span>
<span><span class="co"># change'difficult_conda_env' by the name of the working conda environment</span></span>
<span><span class="fu"><a href="../reference/UpdateEnvCache.html">UpdateEnvCache</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">'method'</span>, conda.env <span class="op">=</span> <span class="st">'difficult_conda_env'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="load_problem">Possible issues with activating environments<a class="anchor" aria-label="anchor" href="#load_problem"></a>
</h3>
<p>It can happen that a conda environment does not work (or stops
working) on a specific machine. Below are some potential causes of
conflicts between Python libraries, conda itself or other components
that could lead to malfunctions (non exhaustive list):</p>
<ol style="list-style-type: decimal">
<li><strong>with rmarkdown/knitr</strong></li>
</ol>
<ol><details><summary><em>How to check</em>
</summary><p>Check if the same command works outside of an rmarkdown (e.g. in a R
script), once you have closed any Rmardown file and closed the R session
(and restrated RStudio). This is something to consider notably when you
encounter an error like:</p>
<pre class="text red-warn"><code>ImportError: /opt/conda/envs/[env_name]/lib/python3.10/site-packages/PIL/../../../libtiff.so.6: undefined symbol: jpeg12_write_raw_data, version LIBJPEG_8.0</code></pre>
</details></ol>
<ol><details><summary><em>How to fix</em>
</summary>
Close any Rmardown file in the source panel, quit the R session (close
RStudio) and work from a R script.
</details></ol>
<ol start="2" style="list-style-type: decimal">
<li><strong>with RStudio</strong></li>
</ol>
<ol><details><summary><em>How to check</em>
</summary><p>Check if the same command works outside of RStudio. For instance, if
there is an error during an integration because scanpy cannot be
imported, try:</p>
<pre><code><span><span class="co"># from a terminal</span></span>
<span><span class="va">R</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r darker-code"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(reticulate)</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">use_condaenv</span>(<span class="st">'[conda_env_name]'</span>)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="sc">&gt;</span> scanpy <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"scanpy"</span>, <span class="at">convert =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co"># error here ?</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="sc">&gt;</span> </span></code></pre></div>
</details></ol>
<ol><details><summary><em>How to fix</em>
</summary>
Lunch the integration outside of RStudio (from a terminal for example).
</details></ol>
<ol start="3" style="list-style-type: decimal">
<li><strong>with reticulate</strong></li>
</ol>
<ol><details><summary><em>How to check</em>
</summary><p>Check if the conda environment loads properly in a pure Python
session. For instance, if there is an error during an integration
because scanpy cannot be imported, try to:</p>
<pre><code>conda activate [conda_env_name]
python</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode python darker-code"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> scanpy</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="co"># error here ?</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span></span></code></pre></div>
</details></ol>
<ol><details><summary><em>How to fix</em>
</summary><p>First, try to update reticulate. If it doesn’t work any better, check
if someone has encountered the same issue (browse the web or the issues
on the reticulate github repository. If nothing works, either post an
issue on the reticulate github repos or retry to import after you have
installed different Python package versions.</p>
If this is a problem with <code>mkl</code>, install the conda
environment again with the arguments <code>nomkl</code> (and
<code>-c conda-forge</code> if not already).
</details></ol>
<ol start="4" style="list-style-type: decimal">
<li><strong>between Python packages</strong></li>
</ol>
<ol><details><summary><em>How to check</em>
</summary><p>This is more tricky. But some packages are know to be incompatible.
For instance, jax and jaxlib work better when their versions are
identical. In my experience, the <code>scvi-tools</code> environment can
be set up with two discrepant versions of jax and jaxlib. To check,
try:</p>
<pre><code>conda list -n [conda_env_name] jax</code></pre>
</details></ol>
<ol><details><summary><em>How to fix</em>
</summary>
If this is a problem with jax and jaxlib, try to force install them with
identical versions. Otherwise, search your error on the web.
</details></ol>
<ol start="5" style="list-style-type: decimal">
<li><strong>between your local os and the list of packages to be
installed by SeuratIntegrate</strong></li>
</ol>
<ol><details><summary><em>How to check</em>
</summary>
This is more an installation problem usually. Check the <a href="#install_problem">previous section</a>.
</details></ol>
<ol><details><summary><em>How to fix</em>
</summary>
This is more an installation problem usually. Check the <a href="#install_problem">previous section</a>.
</details></ol>
</div>
</div>
<div class="section level2">
<h2 id="subtleties-of-using-future">Subtleties of using Future<a class="anchor" aria-label="anchor" href="#subtleties-of-using-future"></a>
</h2>
<p>If the following bullet points seem obscure, further explanations are
given in the sections below. In brief,</p>
<blockquote style="font-size: 1em;">
<ul>
<li>
<strong>disable future</strong> for R-based methods
(<code>DoIntegrate([...], use.future = FALSE)</code>)</li>
<li>
<strong>never use</strong> <code>CCA</code> and <code>RPCA</code>
integration methods with multisession (previous advice prevents this,
especially for Windows users)</li>
<li>multicore futures are faster and less memory-intensive than
multisession, but unstable on RStudio and <strong>unavailable on
Windows</strong>
</li>
<li>to force <code><a href="../reference/DoIntegrate.html">DoIntegrate()</a></code> to use a multicore framework (at
your own risk), set
<code>options(parallelly.fork.enable = FALSE)</code>.
<strong>Unavailable on Windows</strong>
</li>
</ul>
</blockquote>
<div class="section level3">
<h3 id="why-seuratintegrate-uses-future">Why SeuratIntegrate uses Future ?<a class="anchor" aria-label="anchor" href="#why-seuratintegrate-uses-future"></a>
</h3>
<p>A R session can only initialise one Python environment at a time via
reticulate. This <a href="https://datascience.stackexchange.com/questions/109823/multiple-conda-enviroments-in-r-functions-using-reticulate#110554" class="external-link">known</a>
<a href="https://rstudio.github.io/reticulate/reference/use_python.html#caveats-1" class="external-link">limitation</a>
of <code>reticualte</code> is overcome by launching a “<em>background
session</em>” using <code>Future</code>. The environment is initialised
there instead of the main user’s R session. This feature is embedded in
<code><a href="../reference/DoIntegrate.html">DoIntegrate()</a></code>.</p>
<p>Futures are therefore useless for R-based methods and should be
disabled with <code>DoIntegrate([...], use.future = FALSE)</code>.
Worse, it is <strong>discouraged</strong> with
<code>CCAIntegration</code> and <code>RPCAIntegration</code>
(explanations are in the final part of the vignette)</p>
</div>
<div class="section level3">
<h3 id="inconveniences">Inconveniences<a class="anchor" aria-label="anchor" href="#inconveniences"></a>
</h3>
<p>In the vast majority of cases, the impact of the “<em>futures</em>”
is insignificant. The most obvious are the few needed seconds to launch
the future session and export globals, in addition to the <a href="https://cran.r-project.org/web/packages/future/vignettes/future-2-output.html" class="external-link">reordering
of stdout and message output</a>, resulting in messy and less
informative print statements intended for the user.</p>
</div>
<div class="section level3">
<h3 id="tweaks">Tweaks<a class="anchor" aria-label="anchor" href="#tweaks"></a>
</h3>
<p>The package implements sequential, multicore, multisession, and
cluster futures. <code>SeuratIntegrate</code> only uses the multicore
and multisession ones. <code><a href="../reference/DoIntegrate.html">DoIntegrate()</a></code> automatically picks
the preferred one based on the output of</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">parallelly</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/supportsMulticore.html" class="external-link">supportsMulticore</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<p>Here multicore is not supported, thus <code><a href="../reference/DoIntegrate.html">DoIntegrate()</a></code>
would start a multisession. Further explanations regarding settings
giving priority to multicore are available in the function’s help (the
important part is in the disclosure widget
<code><a href="https://parallelly.futureverse.org/reference/supportsMulticore.html" class="external-link">?supportsMulticore</a></code>)</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/help.html" class="external-link">help</a></span><span class="op">(</span><span class="st">'supportsMulticore'</span>, package <span class="op">=</span> <span class="st">'parallelly'</span><span class="op">)</span></span></code></pre></div>
<details><summary><code>?supportsMulticore</code>
</summary><blockquote style="font-size: 1em;">
<h4>Support for process forking

</h4>
<p>While R supports forked processing on Unix-like operating system such as
Linux and macOS, it does not on the Microsoft Windows operating system.
</p>
<p>For some R environments it is considered unstable to perform parallel
processing based on <em>forking</em>.
This is for example the case when using RStudio, cf.
<a href="https://github.com/rstudio/rstudio/issues/2597#issuecomment-482187011" class="external-link">RStudio Inc. recommends against using forked processing when running R from within the RStudio software</a>.
This function detects when running in such an environment and returns
<code>FALSE</code>, despite the underlying operating system supports forked processing.
A warning will also be produced informing the user about this the first
time time this function is called in an <span class="rlang"><b>R</b></span> session.
This warning can be disabled by setting R option
<code>parallelly.supportsMulticore.unstable</code>, or environment variable
<span class="env">R_PARALLELLY_SUPPORTSMULTICORE_UNSTABLE</span> to <code>"quiet"</code>.
</p>


<h4>Enable or disable forked processing

</h4>
<p>It is possible to disable forked processing for futures by setting <span class="rlang"><b>R</b></span>
option <code>parallelly.fork.enable</code> to <code>FALSE</code>.  Alternatively, one can
set environment variable <span class="env">R_PARALLELLY_FORK_ENABLE</span> to <code>false</code>.
Analogously, it is possible to override disabled forking by setting one
of these to <code>TRUE</code>.
</p>

</blockquote>
</details><p><br>In a nutshell, multicore is</p>
<ul>
<li>unavailable on Windows</li>
<li>discouraged (considered unstable) in some R environments, notably
RStudio</li>
<li>always used on Unix-like operating systems when
<code>options(parallelly.fork.enable = TRUE)</code>
</li>
</ul>
<p>The main reason for using multicore is that FORKing is considered to
be faster and result in a lower memory overhead than PSOCK
(i.e. multisession) (see <a href="https://r-bayesian-networks.org/articles/multiprocessing.html#fork-vs--psock" class="external-link">there</a>
for technical details)</p>
<p>Furthermore, <code><a href="../reference/DoIntegrate.html">DoIntegrate()</a></code> uses not only future, but
also NSE (non-standard evaluation), enabling to specify arguments within
each integration function call. Briefly, each call inside
<code><a href="../reference/DoIntegrate.html">DoIntegrate()</a></code> (such as
<code>DoIntegrate(bbknnIntegration())</code>) is not directly executed
but <em>captured</em> to be executed later on (so that the proper value
for the <code>object</code> parameter can be passed on to
<code>bbknnIntegration</code> for instance). Further details are
available in the book <a href="http://adv-r.had.co.nz/Computing-on-the-language.html" class="external-link">Advanced
R</a> by Hadley Wickham.</p>
<p>The important part is that, unlike for multicore, on a multisession
future, <code><a href="../reference/DoIntegrate.html">DoIntegrate()</a></code> evaluates each argument before
launching the integration on the background R session. Thus, a Seurat
Assay object is passed as a <code>str</code>ucture (output of
<code>str(object)</code>). This takes time and makes the call extremely
long.</p>
<p>It has a unexpected side-effect. It slows down
<code>CCAIntegration</code> and <code>RPCAIntegration</code> a lot when
they are input with Seurat objects normalised with
<code><a href="https://satijalab.org/seurat/reference/SCTransform.html" class="external-link">SCTransform()</a></code>. Indeed, they both call
<code><a href="https://satijalab.org/seurat/reference/FindIntegrationAnchors.html" class="external-link">FindIntegrationAnchors()</a></code> -&gt; <code><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge()</a></code> -&gt;
<code>merge.SCTAssay()</code>. The latter performs a <code>grep</code>
on the previous calls (output of <code><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">sys.calls()</a></code>). In a
multisession future, big objects such as the Seurat Assay object are
passed as a <code>str</code>ucture and the <code>grep</code> can be
unnecessarily time-consuming. To avoid this, one can either specify
<code>use.future = FALSE</code> for the R-based method (this is always
preferable) or at least ban the use of <code>CCA</code> and
<code>RPCA</code> integrations with a multisession future (note that
Windows users can only pick the first option).</p>
<!-- Now you can use the python-based methods ! -->
<!-- However, you can only load and attach one conda environment per R session. If -->
<!-- you plan to use multiple python-based methods, you need to launch as many -->
<!-- sessions as integrations using those methods. To circumvent this limitation of -->
<!-- reticulate, you can take advantage of the R package `future`. It allows you to -->
<!-- launch background R sessions, in such a way that the conda environments will be -->
<!-- loaded on those sessions and not on the main one. Simply follow one of the -->
<!-- syntaxes below (`seu` is a Seurat object, and `IntegrateLayers()` is the -->
<!-- function to call any integration method): -->
<!-- ### Working on RStudio and outside -->
<!-- ```{r, eval=FALSE} -->
<!-- library(future) -->
<!-- plan(multisession) -->
<!-- seu %<-% { IntegrateLayers(seu, method = bbknnIntegration) } %seed% 42L # seu is a promise -->
<!-- seu                                                                     # seu is evaluated -->
<!-- plan(multisession) -->
<!-- seu %<-% { IntegrateLayers(seu, method = scVIIntegration) } %seed% 42L  # seu is a promise -->
<!-- seu                                                                     # seu is evaluated -->
<!-- ``` -->
<!-- ### Not working on RStudio -->
<!-- ```{r, eval=FALSE} -->
<!-- library(future) -->
<!-- plan(multicore) # needed just once -->
<!-- seu %<-% { IntegrateLayers(seu, method = bbknnIntegration) } %seed% 42L # seu is a promise -->
<!-- seu                                                                     # seu is evaluated -->
<!-- seu %<-% { IntegrateLayers(seu, method = scVIIntegration) } %seed% 42L  # seu is a promise -->
<!-- seu                                                                     # seu is evaluated -->
<!-- ``` -->
<!-- ### In case of failing -->
<!-- In practice, if an error is thrown during the evaluation, the Seurat object -->
<!-- would be lost and `seu` would stay a (failed) promise. To avoid this, we can use -->
<!-- another syntax: -->
<!-- ```{r, eval=FALSE} -->
<!-- library(future) -->
<!-- plan(multisession) #or plan(multicore) -->
<!--  f <- future({ IntegrateLayers(seu, method = bbknnIntegration) })  # f is a promise -->
<!--  seu <- value(f)                                                   # f is evaluated -->
<!-- ``` -->
<!-- The difference comes from the fact that the promise is evaluated at the last -->
<!-- line. If an error is thrown, the variable `seu` is handled by R, preventing it -->
<!-- to be overwritten. Because it is safer, it might come in handy if you are not -->
<!-- familiar with integration methods from `SeuratIntegrate`. -->
<!-- Another error occurs when the total size of exported objects is too high. -->
<!-- ``` -->
<!-- Error in getGlobalsAndPackages(expr, envir = envir, globals = TRUE) :  -->
<!--   The total size of the X globals that need to be exported for the future expression ('FUN()') is X GiB. This exceeds the maximum allowed size of 500.00 MiB (option 'future.globals.maxSize'). The X largest globals are ... -->
<!-- ``` -->
<!-- By default, `future` allows 500MB per thread. `Seurat` objects tend to grow -->
<!-- quickly, hence it might be necessary to increase the limit. Below is an example -->
<!-- to allow 1.5GB per thread: -->
<!-- ```{r, eval=FALSE} -->
<!-- library(future) -->
<!-- ngb <- 1.5  # 1.5GB -->
<!-- options(future.globals.maxSize = ngb * 1e3 * 1024 ^ 2)  -->
<!-- plan(multisession) #or plan(multicore) -->
<!-- # ... -->
<!-- ``` -->
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Florian Specque, Domitille Chalopin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
