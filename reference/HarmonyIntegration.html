<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Run Harmony on Seurat's Assay5 object through IntegrateLayers — HarmonyIntegration • SeuratIntegrate</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Run Harmony on Seurat's Assay5 object through IntegrateLayers — HarmonyIntegration"><meta name="description" content="A wrapper to run Harmony on multi-layered Seurat V5 object
Can be called via SeuratIntegrate::HarmonyIntegration() or
HarmonyIntegration.fix()"><meta property="og:description" content="A wrapper to run Harmony on multi-layered Seurat V5 object
Can be called via SeuratIntegrate::HarmonyIntegration() or
HarmonyIntegration.fix()"><meta property="og:image" content="https://fspecque.github.io/test/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">SeuratIntegrate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/SeuratIntegrate.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/introduction.html">Integration example: pbmcsca data</a></li>
    <li><a class="dropdown-item" href="../articles/setup_and_tips.html">Advice about conda and future</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Aide-mémoires"><span class="fa fa-sticky-note"></span></button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-"><li><a class="dropdown-item" href="../articles/memo_integration.html">Integration methods</a></li>
    <li><a class="dropdown-item" href="../articles/memo_score.html">Scoring metrics</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cbib/Seurat-Integrate/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Run Harmony on Seurat's <a href="https://satijalab.github.io/seurat-object/reference/Assay5-class.html" class="external-link">Assay5</a> object through <code><a href="https://satijalab.org/seurat/reference/IntegrateLayers.html" class="external-link">IntegrateLayers</a></code></h1>
      <small class="dont-index">Source: <a href="https://github.com/cbib/Seurat-Integrate/blob/main/R/Harmony.R" class="external-link"><code>R/Harmony.R</code></a></small>
      <div class="d-none name"><code>HarmonyIntegration.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>A wrapper to run <code><a href="https://rdrr.io/pkg/harmony/man/RunHarmony.html" class="external-link">Harmony</a></code> on multi-layered Seurat V5 object</p>
<p>Can be called via <code>SeuratIntegrate::HarmonyIntegration()</code> or
<code>HarmonyIntegration.fix()</code></p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">HarmonyIntegration</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">orig</span>,</span>
<span>  groups <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  groups.name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  layers <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  scale.layer <span class="op">=</span> <span class="st">"scale.data"</span>,</span>
<span>  features <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  new.reduction <span class="op">=</span> <span class="st">"harmony"</span>,</span>
<span>  dims <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  key <span class="op">=</span> <span class="st">"harmony_"</span>,</span>
<span>  seed.use <span class="op">=</span> <span class="fl">42L</span>,</span>
<span>  theta <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  sigma <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  lambda <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  nclust <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ncores <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  max_iter <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  early_stop <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  plot_convergence <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  .options <span class="op">=</span> <span class="fu">harmony_options</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">HarmonyIntegration.fix</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>A <code><a href="https://satijalab.github.io/seurat-object/reference/Seurat-class.html" class="external-link">Seurat</a></code> object
(or an <code><a href="https://satijalab.github.io/seurat-object/reference/Assay5-class.html" class="external-link">Assay5</a></code> object if
not called by <code><a href="https://satijalab.org/seurat/reference/IntegrateLayers.html" class="external-link">IntegrateLayers</a></code>)</p></dd>


<dt id="arg-orig">orig<a class="anchor" aria-label="anchor" href="#arg-orig"></a></dt>
<dd><p><code><a href="https://satijalab.github.io/seurat-object/reference/DimReduc-class.html" class="external-link">DimReduc</a></code> object. Not to be set
directly when called with <code><a href="https://satijalab.org/seurat/reference/IntegrateLayers.html" class="external-link">IntegrateLayers</a></code>, use
<code>orig.reduction</code> argument instead</p></dd>


<dt id="arg-groups">groups<a class="anchor" aria-label="anchor" href="#arg-groups"></a></dt>
<dd><p>A <b>named</b> data frame with grouping information. Preferably
one-column when <code>groups.name = NULL</code></p></dd>


<dt id="arg-groups-name">groups.name<a class="anchor" aria-label="anchor" href="#arg-groups-name"></a></dt>
<dd><p>Column name from <code>groups</code> data frame that stores
grouping information. If <code>groups.name = NULL</code>, the first column is used</p></dd>


<dt id="arg-layers">layers<a class="anchor" aria-label="anchor" href="#arg-layers"></a></dt>
<dd><p>Ignored unless <code>groups = NULL</code>, then used to create
grouping variable to correct batch-effect.</p></dd>


<dt id="arg-scale-layer">scale.layer<a class="anchor" aria-label="anchor" href="#arg-scale-layer"></a></dt>
<dd><p>Ignored</p></dd>


<dt id="arg-features">features<a class="anchor" aria-label="anchor" href="#arg-features"></a></dt>
<dd><p>Ignored</p></dd>


<dt id="arg-new-reduction">new.reduction<a class="anchor" aria-label="anchor" href="#arg-new-reduction"></a></dt>
<dd><p>Name of the new integrated dimensional reduction</p></dd>


<dt id="arg-dims">dims<a class="anchor" aria-label="anchor" href="#arg-dims"></a></dt>
<dd><p>Dimensions of dimensional reduction to use for integration.
All used by default</p></dd>


<dt id="arg-key">key<a class="anchor" aria-label="anchor" href="#arg-key"></a></dt>
<dd><p>Prefix for the dimension names computed by harmony.</p></dd>


<dt id="arg-seed-use">seed.use<a class="anchor" aria-label="anchor" href="#arg-seed-use"></a></dt>
<dd><p>An integer to generate reproducible outputs.
Set <code>seed.use = NULL</code> to disable</p></dd>


<dt id="arg-theta">theta<a class="anchor" aria-label="anchor" href="#arg-theta"></a></dt>
<dd><p>Diversity clustering penalty parameter. Specify for
each variable in vars_use Default theta=2. theta=0 does not
encourage any diversity. Larger values of theta result in more
diverse clusters.</p></dd>


<dt id="arg-sigma">sigma<a class="anchor" aria-label="anchor" href="#arg-sigma"></a></dt>
<dd><p>Width of soft kmeans clusters. Default
sigma=0.1. Sigma scales the distance from a cell to cluster
centroids. Larger values of sigma result in cells assigned to
more clusters. Smaller values of sigma make soft kmeans cluster
approach hard clustering.</p></dd>


<dt id="arg-lambda">lambda<a class="anchor" aria-label="anchor" href="#arg-lambda"></a></dt>
<dd><p>Ridge regression penalty. Default lambda=1. Bigger
values protect against over correction. If several covariates
are specified, then lambda can also be a vector which needs to
be equal length with the number of variables to be
corrected. In this scenario, each covariate level group will be
assigned the scalars specified by the user. If set to NULL,
harmony will start lambda estimation mode to determine lambdas
automatically and try to minimize overcorrection (Use with caution still
in beta testing).</p></dd>


<dt id="arg-nclust">nclust<a class="anchor" aria-label="anchor" href="#arg-nclust"></a></dt>
<dd><p>Number of clusters in model. nclust=1 equivalent to
simple linear regression.</p></dd>


<dt id="arg-ncores">ncores<a class="anchor" aria-label="anchor" href="#arg-ncores"></a></dt>
<dd><p>Number of processors to be used for math operations
when optimized BLAS is available. If BLAS is not supporting
multithreaded then this option has no effect. By default,
ncore=1 which runs as a single-threaded process. Although
Harmony supports multiple cores, it is not optimized for
multithreading. Increase this number for large datasets iff
single-core performance is not adequate.</p></dd>


<dt id="arg-max-iter">max_iter<a class="anchor" aria-label="anchor" href="#arg-max-iter"></a></dt>
<dd><p>Maximum number of rounds to run Harmony. One round
of Harmony involves one clustering and one correction step.</p></dd>


<dt id="arg-early-stop">early_stop<a class="anchor" aria-label="anchor" href="#arg-early-stop"></a></dt>
<dd><p>Enable early stopping for harmony. The
harmonization process will stop when the change of objective
function between corrections drops below 1e-4</p></dd>


<dt id="arg-plot-convergence">plot_convergence<a class="anchor" aria-label="anchor" href="#arg-plot-convergence"></a></dt>
<dd><p>Whether to print the convergence plot of
the clustering objective function. TRUE to plot, FALSE to
suppress. This can be useful for debugging.</p></dd>


<dt id="arg--options">.options<a class="anchor" aria-label="anchor" href="#arg--options"></a></dt>
<dd><p>Setting advanced parameters of RunHarmony. This must be the
result from a call to `harmony_options`. See ?`harmony_options` for
parameters not listed above and more details.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Print messages. Set to <code>FALSE</code> to disable</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Ignored for <code>HarmonyIntegration()</code>, or all of the above for
<code>HarmonyIntegration.fix()</code></p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>The function itself returns a list containing:</p><ul><li><p>a new DimReduc of name <code>reduction.name</code> (key set to
  <code>reduction.key</code>) with corrected cell embeddings matrix of
  <code>length(dims)</code> columns.</p></li>
</ul><p>When called via <code><a href="https://satijalab.org/seurat/reference/IntegrateLayers.html" class="external-link">IntegrateLayers</a></code>, a Seurat object with
the new reduction is returned</p>
    </div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>This function requires the
<a href="https://portals.broadinstitute.org/harmony/" class="external-link"><span class="pkg">harmony</span></a> package
to be installed</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Korsunsky, I., Millard, N., Fan, J., Slowikowski, K., Zhang, F.,
Wei, K., Baglaenko, Y., Brenner, M., Loh, P. &amp; Raychaudhuri, S. Fast,
sensitive and accurate integration of single-cell data with Harmony.
Nat Methods 16, 1289–1296 (2019). <a href="https://doi.org/10.1038/s41592-019-0619-0" class="external-link">DOI</a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Preprocessing</span></span></span>
<span class="r-in"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">UpdateSeuratObject</span><span class="op">(</span><span class="fu">SeuratData</span><span class="fu">::</span><span class="fu"><a href="https://satijalab.org/seurat/reference/LoadData.html" class="external-link">LoadData</a></span><span class="op">(</span><span class="st">"pbmcsca"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obj</span><span class="op">[[</span><span class="st">"RNA"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">obj</span><span class="op">[[</span><span class="st">"RNA"</span><span class="op">]</span><span class="op">]</span>, f <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">Method</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">NormalizeData</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">FindVariableFeatures</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">ScaleData</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">RunPCA</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># After preprocessing, we integrate layers based on the "Method" variable:</span></span></span>
<span class="r-in"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">IntegrateLayers</span><span class="op">(</span>object <span class="op">=</span> <span class="va">obj</span>, method <span class="op">=</span> <span class="fu">SeuratIntegrate</span><span class="fu">::</span><span class="va">HarmonyIntegration</span>,</span></span>
<span class="r-in"><span>                       verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># We can also change parameters such as the batch-effect variable.</span></span></span>
<span class="r-in"><span><span class="co"># Here we change the groups variable, the number of dimension used from the original</span></span></span>
<span class="r-in"><span><span class="co"># PCA and minor options from `harmony_options()`:</span></span></span>
<span class="r-in"><span><span class="va">harmonyOptions</span> <span class="op">&lt;-</span> <span class="fu">harmony</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/harmony/man/harmony_options.html" class="external-link">harmony_options</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">harmonyOptions</span><span class="op">$</span><span class="va">max.iter.cluster</span> <span class="op">&lt;-</span> <span class="fl">10</span>   <span class="co">#  20 by default</span></span></span>
<span class="r-in"><span><span class="va">harmonyOptions</span><span class="op">$</span><span class="va">block.size</span> <span class="op">&lt;-</span> <span class="fl">.1</span>         <span class="co"># .05 by default</span></span></span>
<span class="r-in"><span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">IntegrateLayers</span><span class="op">(</span>object <span class="op">=</span> <span class="va">obj</span>, method <span class="op">=</span> <span class="fu">SeuratIntegrate</span><span class="fu">::</span><span class="va">HarmonyIntegration</span>,</span></span>
<span class="r-in"><span>                       dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, plot_convergence <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>                       groups <span class="op">=</span> <span class="va">obj</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Experiment</span>,</span></span>
<span class="r-in"><span>                       new.reduction <span class="op">=</span> <span class="st">"harmony_custom"</span>,</span></span>
<span class="r-in"><span>                       .options <span class="op">=</span> <span class="va">harmonyOptions</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Florian Specque, Domitille Chalopin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

